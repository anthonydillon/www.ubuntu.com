{% set breadcrumbs = get_navigation(request.path).breadcrumbs %}

<header id="navigation" class="p-navigation">
  {% block header_banner %}
  <div class="p-navigation__row">
    <div class="p-navigation__banner">
      <div class="p-navigation__logo">
        <a class="p-navigation__item" href="/">
          <svg class="p-navigation__svg" width="23" height="48" viewBox="0 0 23 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill="#E95420" d="M.05 0H22.1v38H.05z"/><path fill-rule="evenodd" clip-rule="evenodd" d="M15.39 17.04a2.365 2.365 0 1 0-.994 4.625 2.365 2.365 0 0 0 .993-4.624ZM5.392 22.2a2.364 2.364 0 1 0 1.989 2.688A2.365 2.365 0 0 0 5.393 22.2Zm5.71 8.384a5.637 5.637 0 0 1-4.589-3.15 3.242 3.242 0 0 1-2.322.24 7.872 7.872 0 0 0 5.747 4.99 7.926 7.926 0 0 0 2.015.167 3.254 3.254 0 0 1-.852-2.247Zm3.753-2.261a2.365 2.365 0 1 0-.992 4.623 2.365 2.365 0 0 0 .992-4.623Zm3.146-7.945a3.269 3.269 0 0 1-1.487 1.817 5.643 5.643 0 0 1-.189 5.843 3.265 3.265 0 0 1 1.247 2.052 7.827 7.827 0 0 0 1.724-3.48 7.854 7.854 0 0 0-1.295-6.232Zm-5.513-3.245a3.257 3.257 0 0 0-.87 2.18 5.66 5.66 0 0 0-4.745 2.539 3.247 3.247 0 0 0-2.273-.534 7.887 7.887 0 0 1 7.888-4.185Z" fill="#fff"/><path fill="#E95420" d="M.05 33H22.1v5H.05z"/></svg>
          <div class="p-navigation__strapline">Canonical Ubuntu</div>
          <script>performance.mark("Logo rendered")</script>
        </a>
        {% if breadcrumbs %}
        <h5 class="p-navigation--secondary__logo u-hide--nav-threshold-up">
          <a class="p-navigation--secondary__banner" href="{{ breadcrumbs.section.path }}{% if get_test_backend %}?test_backend=true{% endif %}">
            {{ breadcrumbs.section.title }}
          </a>
        </h5>
        {% endif %}

        {% if section_title and section_path %}
        <h5 class="p-navigation--secondary__logo u-hide--nav-threshold-up">
          <a class="p-navigation--secondary__banner" href="{{ section_path }}">
            {{ section_title }}
          </a>
        </h5>
        {% endif %}
      </div>

      <div class="u-hide u-show--small js-account--small"></div>
    </div>
    <nav class="p-navigation__nav">
      {% if get_test_backend %}
        <div class="u-hide--small" style="margin-right: -75px; padding: 15px 0 15px 10px">
          <div class="p-label--new">Testing</div>
        </div>
      {% endif %}
      <ul class="p-navigation__items u-hide js-show-nav" role="menu">
        <li class="p-navigation__item p-navigation__dropdown-link" role="menuitem" id="enterprise" onmouseover="fetchDropdown('/templates/navigation-enterprise-h', 'enterprise-content'); this.onmouseover = null;">
          <a class="p-navigation__link-anchor" href="#enterprise-content" onfocus="fetchDropdown('/templates/navigation-enterprise-h', 'enterprise-content');">Enterprise</a>
        </li>
        <li class="p-navigation__item p-navigation__dropdown-link" role="menuitem" id="developer" onmouseover="fetchDropdown('/templates/navigation-developer-h', 'developer-content'); this.onmouseover = null;">
          <a class="p-navigation__link-anchor" href="#developer-content" onfocus="fetchDropdown('/templates/navigation-developer-h', 'developer-content');">Developer</a>
        </li>
        <li class="p-navigation__item p-navigation__dropdown-link" role="menuitem" id="community" onmouseover="fetchDropdown('/templates/navigation-community-h', 'community-content'); this.onmouseover = null;">
          <a class="p-navigation__link-anchor" href="#community-content" onfocus="fetchDropdown('/templates/navigation-community-h', 'community-content');">Community</a>
        </li>
        <li class="p-navigation__item p-navigation__dropdown-link" role="menuitem" id="download" onmouseover="fetchDropdown('/templates/navigation-download-h', 'download-content'); this.onmouseover = null;">
          <a class="p-navigation__link-anchor" href="#download-content" onfocus="fetchDropdown('/templates/navigation-download-h', 'download-content');">Download</a>
        </li>
      </ul>
      <noscript>
        <ul class="p-navigation__items" role="menu">
          {% include "templates/header_noscript.html" %}
        </ul>
      </noscript>
      <ul class="p-navigation__items u-hide--small">
        <li class="p-navigation__item p-navigation__dropdown-link" role="menuitem" id="download" onmouseover="fetchDropdown('/templates/navigation-download-h', 'download-content'); this.onmouseover = null;">
          <a class="p-navigation__link-anchor" href="#download-content" onfocus="fetchDropdown('/templates/navigation-download-h', 'download-content');">Company</a>
        </li>
        <li class="p-navigation__item" id="link-4">
          <a href="/search" class="js-search-button p-navigation__link-anchor" style="padding-right: 1rem;">
            <span class="u-hide u-show--large">Search</span> <i class="p-icon--search is-dark"></i>
          </a>
        </li>
        <li class="p-navigation__user js-account"></li>
      </ul>
      <div class="p-navigation__search u-show--small u-hide" style="z-index: 39;">
        <form action="/search" class="p-search-box" id="ubuntu-global-search-form">
          <input type="search" class="p-search-box__input" name="q" placeholder="Search our sites" required="" aria-label="Search our sites">
          <button type="reset" class="p-search-box__reset"><i class="p-icon--close"></i></button>
          <button type="submit" class="p-search-box__button"><i class="p-icon--search">Search</i></button>
        </form>
      </div>
    </nav>
  </div>
  {% endblock header_banner %}
</header>
<div class="dropdown-window-overlay fade-animation"></div>
<div class="dropdown-window slide-animation">
  <div class="u-hide" id="enterprise-content"></div>
  <div class="u-hide" id="developer-content">  </div>
  <div class="u-hide" id="community-content"></div>
  <div class="u-hide" id="download-content"></div>
</div>
{% if not(hide_subnav == True) %}
{% if breadcrumbs and breadcrumbs.children or breadcrumbs.grandchildren %}
<nav class="p-navigation--secondary">
  <div class="row">
    <div class="col-10 u-equal-height">
      <a class="p-navigation--secondary__banner u-hide--nav-threshold-down" href="{{ breadcrumbs.section.path }}{% if get_test_backend %}?test_backend=true{% endif %}">
        <h5 class="p-navigation--secondary__logo">
          {{ breadcrumbs.section.title | replace(" ", "&nbsp;") | safe }}
        </h5>
      </a>
      {% if breadcrumbs.children %}
      <ul class="breadcrumbs--secondary">
        {% for child in breadcrumbs.children %}
          {% if child.path == '/blog/topics' %}
          <li class="breadcrumbs__item p-contextual-menu u-hide--small">
            <a aria-controls="#topics" data-trigger="hover" class="breadcrumbs__link u-no-margin--bottom {% if child.active %}p-link--active{% endif %} p-contextual-menu__toggle" href="#">{{ child.title }}</a>

            <span class="p-contextual-menu__dropdown" id="topics" aria-hidden="true" aria-label="submenu" style="left: 1rem; font-size: .875rem;">
              <span class="p-contextual-menu__group">
                {% for item in child.children %}
                <a href="{{ item.path }}" class="p-contextual-menu__link breadcrumbs">{{ item.title }}</a>
                {% endfor %}
              </span>
            </span>
          </li>
          {% elif child.path != '/blog/archives' and child.path != '/blog/upcoming' %}
          <li class="breadcrumbs__item">
            <a class="breadcrumbs__link {% if child.active %}p-link--active{% endif %}" href="{{ child.path }}{% if get_test_backend %}?test_backend=true{% endif %}">{{ child.title }}</a>
          </li>
          {% endif %}

          {% if breadcrumbs.grandchildren %}
          <li class="breadcrumbs__item"><span class="breadcrumbs__chevron u-hide--small">&rsaquo;</span><span class="u-show--small">&nbsp;</span></li>
            {% for grandchild in breadcrumbs.grandchildren %}
            <li class="breadcrumbs__item">
              <a class="breadcrumbs__link {% if grandchild.active %}p-link--active{% endif %}" href="{{ grandchild.path }}">
                {{ grandchild.title }}
              </a>
            </li>
            {% endfor %}
          {% endif %}
        {% endfor %}

        {% for child in breadcrumbs.children %}
          {% if child.path == "/blog/topics" %}
            {% for item in child.children %}
            <li class="breadcrumbs__item u-hide--medium u-hide--large">
              <a class="breadcrumbs__link {% if request.path == item.path %}p-link--active {% endif %}" href="{{ item.path }}">{{ item.title }}</a>
            </li>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    <div class="col-2">
      <div class="breadcrumbs__cta u-float-right">
        <a class="p-button--neutral is-dense u-no-margin--bottom" href="#">Try it now</a>
      </div>
    </div>
  </div>
</nav>
{% endif %}
{% endif %}

<script>
  var nav = document.querySelector('.js-show-nav');
  var hash = window.location.hash;
  nav.classList.remove('u-hide');

  // If the page loads with a preselected hash load and open the menu
  if (hash) {
    try {
      var selected = nav.querySelector(hash);
    } catch(error) {
      console.warn("Hash " + hash + " not found in topnav");
    }
    if (selected) {
      selected.onmouseover();
    }
  }

  function fetchDropdown(url, id) {
    var div = document.getElementById(id);
    var req = new XMLHttpRequest();
    req.open('GET', url);
    req.send();
    req.addEventListener('load', function() {
      div.innerHTML = this.responseText;
    });
  }

  function initSearch() {
    var searchButton = document.querySelector('.js-search-button');
    var searchReset = document.querySelector('.p-search-box__reset');
    if (searchButton) {
      searchButton.addEventListener('click', openSearch);
    }

    if (searchReset) {
      searchReset.addEventListener('click', closeSearch);
    }
  }
  initSearch();

  function openSearch(e) {
    e.preventDefault();
    var navigation = document.querySelector('.p-navigation__nav');
    var dropdownWindowOverlay = document.querySelector(".dropdown-window-overlay");
    var banner = document.querySelector(".p-navigation__banner");
    var dropdownWindow = document.querySelector(".dropdown-window");
    var navigationItems = document.querySelector('.p-navigation__items');
    var searchButton = document.querySelector('.js-search-button');
    var search = document.querySelector('.p-navigation__search');
    var searchInput = document.querySelector('.p-search-box__input');
    var searchActive = !search.classList.contains('u-hide');
    search.classList.remove('u-hide');
    searchButton.classList.add('u-hide');
    banner.style= "opacity: 0.4; transition: opacity 0.5s ease-in-out;"
    navigationItems.style= "opacity: 0.4; transition: opacity 0.5s ease-in-out;"
    dropdownWindow.style="z-index: 37;"
    dropdownWindowOverlay.classList.remove("fade-animation");
    navigation.classList.add('has-active-search');
    searchInput.focus();
    dropdownWindowOverlay.addEventListener('click', closeSearch);
    document.addEventListener('keyup', keyPressHandler);
  }

  function closeSearch() {
    var navigation = document.querySelector('.p-navigation__nav');
    var banner = document.querySelector(".p-navigation__banner")
    var dropdownWindow = document.querySelector(".dropdown-window");
    var dropdownWindowOverlay = document.querySelector(".dropdown-window-overlay");
    var navigationItems = document.querySelector('.p-navigation__items');
    var searchButton = document.querySelector('.js-search-button');
    var search = document.querySelector('.p-navigation__search');
    search.classList.add('u-hide');
    banner.style= "opacity: 1;"
    dropdownWindow.style="z-index: 39;"
    navigationItems.style= "opacity: 1;"
    dropdownWindowOverlay.classList.add("fade-animation");
    navigation.classList.remove('has-active-search');
    searchButton.classList.remove('u-hide');
    document.removeEventListener('keyup', keyPressHandler);
    dropdownWindowOverlay.removeEventListener('click', closeSearch);
  }

  function keyPressHandler (e) {
    console.log(e);
    if (e.key === "Escape") {
      closeSearch();
    }
  }
</script>
